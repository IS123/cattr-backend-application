# Required to setup next project secret variables:
# - PRODUCTION_SSH_IP
# - PRODUCTION_SSH_USER
# - PRODUCTION_SSH_PASSWORD - private ssh key!

# Ð¢ot mandatory variables (with defaults):
# - PRODUCTION_SSH_PATH = /opt/amazing-time
# - PRODUCTION_SSH_PORT = 22
# - PRODUCTION_STORAGE_PATH = $PRODUCTION_SSH_PATH/storage

# Folders and files on production
# - $PRODUCTION_STORAGE_PATH - persistent storage
# - $PRODUCTION_SSH_PATH - project CD workfolder
# - --/storage - default persistent storage path (if $PRODUCTION_STORAGE_PATH not setted)
# - --/builds - builds folder
# - --/current - symlink to current deployed version
# - --/.build_id - current build id (for version history)
# - --/.build_history - history of version changes (for rollback strategy)

# Web server should be settuped to path: $PRODUCTION_SSH_PATH/current/public

stages:
  - build
  - pack
  - deploy

cache:
  # using single cache volume
  key: package-cache
  untracked: true
  paths:
    - public/js
    - public/apidoc
    - vendor/
    - build-pack.tar.gz


# Build Jobs

#build-backend:
#  stage: build
#  only:
#    variables:
#      - $CI_COMMIT_TAG =~ /^release-.*/
#  environment:
#    name: production
#  script:
#    - deploy/01.1.build-composer.sh
#
#build-front:
#  stage: build
#  only:
#    variables:
#      - $CI_COMMIT_TAG =~ /^release-.*/
#  environment:
#    name: production
#  script:
#    - deploy/01.2.build-npm.sh
#
## Create package archive
#
#create-package:
#  stage: pack
#  only:
#    variables:
#      - $CI_COMMIT_TAG =~ /^release-.*/
#  environment:
#    name: production
#  script:
#    - deploy/02.1.create-package.sh

# Upload archive to production and setup it

deploy-production:
  stage: deploy
  only:
    variables:
      - $CI_COMMIT_TAG =~ /^release-.*/
#  dependencies:
#    - create-package
  script:
    - deploy/03.1.upload.sh
